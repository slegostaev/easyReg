@(message: String)

@main("easyReg") {
	<!--     <script src='@routes.Assets.at("javascripts/scheduler/connector/connector.js")' type="text/javascript"></script> -->

    <link rel="stylesheet" href='@routes.Assets.at("stylesheets/scheduler/dhtmlxscheduler.css")' type="text/css">
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/dhtmlxscheduler.js")' type="text/javascript"></script>

    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_units.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_collision.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_limit.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_timeline.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_minical.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_editors.js")' type="text/javascript"></script>
    
    <script src='@routes.Assets.at("javascripts/dhtmlx/locale/locale_ru.js")' type="text/javascript"></script>
    
    <script src='@routes.Assets.at("javascripts/dhtmlx/common/dhtmlxCombo/dhtmlxcombo.js")' type="text/javascript"></script>
    <link rel="stylesheet" href='@routes.Assets.at("javascripts/dhtmlx/common/dhtmlxCombo/dhtmlxcombo.css")'>
    
    <script type="text/javascript" src="@routes.Application.javascriptRoutes()"></script>

    <style type="text/css" media="screen">
        html, body{
            margin:0px;
            padding:0px;
            height:100%;
            overflow:hidden;
        }
        
        /* Important !!! */
		.dhx_scale_hour{ 
			line-height:normal;
		}
		
		#reception_form {
			position: absolute;
			top: 100px;
			left: 200px;
			z-index: 10001;
			display: none;
			background-color: white;
			border: 2px outset gray;
			padding: 20px;
			font-family: Tahoma;
			font-size: 10pt;
		}

		#reception_form label {
			width: 200px;
		}
    </style>
    <script type="text/javascript">
    
    	var dp;
        $(function() {
        	scheduler.config.default_date = "%l, %j %F %Y";
    		scheduler.config.mark_now = true;
    		scheduler.config.collision_limit = 1;
    		scheduler.config.event_duration = 30; 
    		scheduler.config.auto_end_date = true;
    		scheduler.config.first_hour = 9;
    		scheduler.config.last_hour = 20;
    		scheduler.config.multi_day = false;
    		scheduler.config.show_loadin = true;
    		scheduler.config.details_on_create=true
    		scheduler.config.details_on_dblclick = true;
    		scheduler.config.drag_create = false;
    		scheduler.config.limit_time_select = true;
    		scheduler.config.select = false;
    		scheduler.config.separate_short_events = true;
    		
    		var step = 30;
    		var format = scheduler.date.date_to_str("%H:%i");
    		scheduler.config.time_step = step;
    		scheduler.config.hour_size_px = 88;
    		scheduler.templates.hour_scale = function(date){
    			var html="";
    			for (var i = 0; i < 2; i++) {
    				html += "<div style='height:44px;line-height:44px;'>" + format(date) + "</div>";
    				date = scheduler.date.add(date,step,"minute");
    			}
    			return html;
    		}
    		
    		scheduler.locale.labels.unit_tab = "Doctors"
	      	scheduler.locale.labels.timeline_tab ="Timeline";
// 	      	scheduler.locale.labels.section_patient_name = "Patient name:";

	   		scheduler.addMarkedTimespan({ // blocks each Sunday, Monday, Wednesday
	   		    days:  [0], 
	   		    zones: "fullday",
	   		    type:  "dhx_time_block", 
	   		    css:   "red_section",
	   		 	sections: {	unit: [2, 5], timeline: [2, 5]}
	   		});
    		       		
	   		
	   		scheduler.attachEvent("onMouseMove", function(id, e) {
	   			doctor_id = scheduler.getActionData(e).section;
	   			//console.log(doctor_id);
	   		});
//        		scheduler.config.lightbox.sections = [
// 	   			{ name: "description", height: 50, map_to: "text", type: "textarea", focus: true },
// 	   			{ name: "patient_name", map_to: "patient_name", type: "combo", filtering: true, cache: false,
// 	   				image_path: '@routes.Assets.at("javascripts/dhtmlx/common/dhtmlxCombo/imgs/")', 
// 	   					script_path: "/patient/find_by_name" },
// 	   			{ name: "time", map_to: "auto", type: "time", height: 72, time_format:["%H:%i"]}
//      		];
    		           		
    		        
	        scheduler.attachEvent("onEventSave", function(id, data) {
	  			if (!data.text) {
	  				alert("Text must not be empty");
	  				return false;
	  			}
	  			
	  			console.log(data);
	  			console.log(doctor_id);
	  			return true;
	  		});
    		
        	jsRoutes.controllers.Application.getAllDoctors().ajax().done(function(doctors) {
        		scheduler.createUnitsView({
            	    name : "unit",
            	    property : "doctor_id", 
            	    list : doctors
            	});
        		
        		scheduler.createTimelineView({
	           	     name : "timeline",
	           	     x_unit : "minute",//measuring unit of the X-Axis.
	           	     x_date : "%H:%i", //date format of the X-Axis
	           	     x_step : 30,      //X-Axis step in 'x_unit's
	           	     x_size : 24,      //X-Axis length specified as the total number of 'x_step's
	           	     x_start : 16,     //X-Axis offset in 'x_unit's
	           	     x_length : 48,    //number of 'x_step's that will be scrolled at a time
	           	     y_unit : doctors,	//sections of the view (titles of Y-Axis)
	           	     y_property : "doctor_id", //mapped data property
	           	     render : "bar"             //view mode
	           	});
        		
        		updateScheduler();
        	})
        	
        	
        	
        	scheduler.showLightbox = function(id) {
    			var ev = scheduler.getEvent(id);
    			scheduler.startLightbox(id, html("reception_form"));
    			$("#patient_name").focus().val(ev.patient ? ev.patient.label : '');
    			$("#description").val(ev.text);
    			$("#doctor_name").text(getDoctorName());
    			$("#reception_time").text(getTime(ev.start_date) + '-' + getTime(ev.end_date));
    		};
    		
    		$('#patient_name').autocomplete({
    			source : function(req, resp) {
    				jsRoutes.controllers.Application.findPatientByName(req.term)
    					.ajax().done(function(data) {
    						resp($.map(data, function(item) {
    							return {id : item.key, label : item.label, value : item.label }
    						}));
    					})
    			},
    			select: function( event, ui ) {
    				$.data(this, 'patient-id', ui.item.id);
    		      }
    		})
        })
        
		var html = function(id) { return document.getElementById(id); }; //just a helper
		var doctor_id;

		function save_form() {
			var ev = scheduler.getEvent(scheduler.getState().lightbox_id);
			ev.text = $("#description").val();
			if (ev.patient === undefined) {
				ev.patient = {};
			}
			
			if (ev.doctor === undefined) {
				ev.doctor = {};
			}
			var patientField = $("#patient_name");
			ev.patient.label = patientField.val();
			ev.patient.key = patientField.data('patient-id');
			ev.doctor.key = doctor_id;
			jsRoutes.controllers.ReceptionsController.saveReception().ajax({
				data : {
					id : ev.key,
					patient_id : ev.patient.key,
					doctor_id : ev.doctor.key,
					description: ev.text,
					start_date : ev.start_date.getTime(),
					end_date : ev.end_date.getTime()
				}
			}).done(function(resp) {
				ev.key = resp;
			}).fail(function(resp) {
				alert(resp)
			}).always(function() {
				scheduler.endLightbox(true, html("reception_form"));
			})
		}
		
		function close_form() {
			scheduler.endLightbox(false, html("reception_form"));
		}

		function delete_event() {
			var ev = scheduler.getEvent(scheduler.getState().lightbox_id);
			if (confirm('Вы уверены что хотите удалить эту запись?')) {
				jsRoutes.controllers.ReceptionsController.deleteReception(ev.key).ajax()
					.done(function(resp) {
						scheduler.deleteEvent(ev.id);
					}).fail(function(resp) {
						alert('error')
					}).always(function() {
						scheduler.endLightbox(false, html("reception_form"));
					})
			} else {
				scheduler.endLightbox(false, html("reception_form"));
			}
		}
		
		function getDoctorName() {
			var mode = scheduler.getState().mode;
			var doctor = {};
			if (mode == 'unit') {
				doctor = scheduler._props[mode].options[doctor_id - 1];
			} else {
				doctor = scheduler.matrix[mode].y_unit[doctor_id - 1];	
			}
			return doctor.label;
		}
		
		function getTime(date) {
			return date.getHours() + ":" + date.getMinutes();
		}
		
		function updateScheduler() {
			var state = scheduler.getState();
			scheduler.clearAll();
			scheduler.init('scheduler_here', state.date === undefined ? new Date() : state.date, state.mode === undefined ? "unit" : state.mode);
        	scheduler.load('/receptions/get_all', 'json');
		}
    </script>
	<div id="reception_form">
		<label for="reception_time" style="padding-right: 10px;">Time:</label><span id="reception_time"></span><br>
		<label for="doctor_name" style="padding-right: 10px;">Doctor:</label><span id="doctor_name"></span><br>
		<label for="patient_name" style="padding-right: 10px;">Patient:</label><input type="text" name="patient_name" value="" id="patient_name" 
			data-patinent-id=""><br>

		<label for="description" style="padding-right: 10px;">Description</label>
		<textarea name="description" id="description"></textarea><br>
		
		<input type="button" name="save" value="Save" id="save" style='width:100px;' onclick="save_form()">
		<input type="button" name="close" value="Close" id="close" style='width:100px;' onclick="close_form()">
		<input type="button" name="delete" value="Delete" id="delete" style='width:100px;' onclick="delete_event()">
	</div>
	
    <div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%;'>
        <div class="dhx_cal_navline">
            <div class="dhx_cal_prev_button">&nbsp;</div>
            <div class="dhx_cal_next_button">&nbsp;</div>
            <div class="dhx_cal_today_button"></div>
            <div class="dhx_cal_date"></div>
<!--             <div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div> -->
<!--             <div class="dhx_cal_tab" name="week_tab" style="right:140px;"></div> -->
<!--             <div class="dhx_cal_tab" name="month_tab" style="right:76px;"></div> -->
	        <div class="dhx_cal_tab" name="unit_tab" style="right:280px;"></div>
			<div class="dhx_cal_tab" name="timeline_tab" style="right:280px;"></div>
			<button onclick="updateScheduler()">Refresh</button>
	    </div>
	    
        <div class="dhx_cal_header"></div>
        <div class="dhx_cal_data"></div>
    </div>
}