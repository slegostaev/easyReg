@scheduler_main {
	<!--     <script src='@routes.Assets.at("javascripts/scheduler/connector/connector.js")' type="text/javascript"></script> -->

    <link rel="stylesheet" href='@routes.Assets.at("stylesheets/scheduler/dhtmlxscheduler.css")' type="text/css">
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/dhtmlxscheduler.js")' type="text/javascript"></script>

    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_units.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_collision.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_limit.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_timeline.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_minical.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_editors.js")' type="text/javascript"></script>
    <script src='@routes.Assets.at("javascripts/dhtmlx/scheduler/ext/dhtmlxscheduler_tooltip.js")' type="text/javascript">></script>
    
    <script src='@routes.Assets.at("javascripts/dhtmlx/locale/locale_ru.js")' type="text/javascript"></script>
    
    <script src='@routes.Assets.at("javascripts/dhtmlx/common/dhtmlxCombo/dhtmlxcombo.js")' type="text/javascript"></script>
    <link rel="stylesheet" href='@routes.Assets.at("javascripts/dhtmlx/common/dhtmlxCombo/dhtmlxcombo.css")'>
    
    <script type="text/javascript" src="@routes.ReceptionsController.javascriptRoutes()"></script>

    <style type="text/css" media="screen">
        html, body{
            margin:0px;
            padding:0px;
            height:100%;
            overflow:hidden;
        }
        
        /* Important !!! */
		.dhx_scale_hour{ 
			line-height:normal;
		}
		
		#reception_form {
			position: absolute;
			top: 100px;
			left: 200px;
			z-index: 10001;
			display: none;
			background-color: white;
			border: 2px outset gray;
			padding: 20px;
			font-family: Tahoma;
			font-size: 10pt;
			style="width: 500px; 
			height: 200px;"
		}

		#reception_form label {
			width: 200px;
		}
		
		#reception_form input, #reception_form select  {
			width: 200px;
		}
		
		.ui-autocomplete, .ui-dialog, .ui-front {
			z-index: 11000 !important;
		}

		/* background color for whole container and it's border*/
		.my_event {
			background-color: #add8e6;
			border: 1px solid #778899;
			overflow: hidden;
		}
		/* disabling default color for select menu */
		.dhx_cal_select_menu.my_event div {
			border: 0;
			background-color: transparent;
			color: black;
		}
		/* styles for event content */
		.dhx_cal_event.my_event .my_event_body {

			padding-top: 3px;
			padding-left: 5px;
		}
		/* event's date information */
		.my_event .event_date {
			font-weight: bold;
			padding-right: 5px;
		}
		/* event's resizing section */
		.my_event_resize {
			height: 3px;
			position: absolute;
			bottom: -1px;
		}
		/* event's move section */
		.my_event_move {
			position: absolute;
			top: 0;
			height: 10px;
			cursor: pointer;
		}
		
		/*event in day or week view*/
        .dhx_cal_event.first_time_event div{
            background-color: green !important;
            color: white !important;
        }
        /*multi-day event in month view*/
        .dhx_cal_event_line.first_time_event{
            background-color: green !important;
            color: white !important;
        }
        /*first_time event , in month view*/
        .dhx_cal_event_clear.first_time_event{
            color: green !important;
        }
    </style>
    <script type="text/javascript">
    
    	var dp;
        $(function() {
        	scheduler.config.default_date = "%l, %j %F %Y";
    		scheduler.config.mark_now = true;
    		scheduler.config.collision_limit = 1;
    		scheduler.config.event_duration = 30; 
    		scheduler.config.auto_end_date = true;
    		scheduler.config.first_hour = 9;
    		scheduler.config.last_hour = 20;
    		scheduler.config.multi_day = false;
    		scheduler.config.show_loadin = true;
    		scheduler.config.details_on_create=true
    		scheduler.config.details_on_dblclick = true;
    		scheduler.config.drag_create = false;
    		scheduler.config.limit_time_select = true;
    		scheduler.config.select = false;
    		scheduler.config.separate_short_events = true;
    		
    		var step = 30;
    		var format = scheduler.date.date_to_str("%H:%i");
    		scheduler.config.time_step = step;
    		scheduler.config.hour_size_px = 88;
    		scheduler.templates.hour_scale = function(date) {
    			var html= '';
    			for (var i = 0; i < 2; i++) {
    				html += '<div style="height:44px;line-height:44px;">' + format(date) + '</div>';
    				date = scheduler.date.add(date, step, "minute");
    			}
    			return html;
    		}
    		
    		scheduler.locale.labels.unit_tab = "Doctors"
	      	scheduler.locale.labels.timeline_tab ="Timeline";
// 	      	scheduler.locale.labels.section_patient_name = "Patient name:";

	   		scheduler.addMarkedTimespan({ // blocks each Sunday, Monday, Wednesday
	   		    days:  [0], 
	   		    zones: "fullday",
	   		    type:  "dhx_time_block", 
	   		    css:   "red_section",
	   		 	sections: {	unit: [2, 5], timeline: [2, 5]}
	   		});
	   		
	   		scheduler.templates.event_class = function(start, end, event) {
	   			if (event.first_time) {
	   				return 'first_time_event';
	   			}
	   		}
    		       		
	   		
	   		scheduler.attachEvent("onMouseMove", function(id, e) {
	   			doctor_id = scheduler.getActionData(e).section;
	   			//console.log(doctor_id);
	   		});
//        		scheduler.config.lightbox.sections = [
// 	   			{ name: "description", height: 50, map_to: "text", type: "textarea", focus: true },
// 	   			{ name: "patient_name", map_to: "patient_name", type: "combo", filtering: true, cache: false,
// 	   				image_path: '@routes.Assets.at("javascripts/dhtmlx/common/dhtmlxCombo/imgs/")', 
// 	   					script_path: "/patient/find_by_name" },
// 	   			{ name: "time", map_to: "auto", type: "time", height: 72, time_format:["%H:%i"]}
//      		];
    		           		
    		        
	        scheduler.attachEvent("onEventSave", function(id, data) {
	  			if (!data.text) {
	  				alert("Text must not be empty");
	  				return false;
	  			}
	  			
	  			console.log(data);
	  			console.log(doctor_id);
	  			return true;
	  		});
    		
        	jsRoutes.controllers.DoctorsController.getAllDoctorsJSON().ajax().done(function(doctors) {
        		scheduler.createUnitsView({
            	    name : "unit",
            	    property : "doctor_id", 
            	    list : doctors
            	});
        		
        		scheduler.createTimelineView({
	           	     name : "timeline",
	           	     x_unit : "minute",//measuring unit of the X-Axis.
	           	     x_date : "%H:%i", //date format of the X-Axis
	           	     x_step : 30,      //X-Axis step in 'x_unit's
	           	     x_size : 24,      //X-Axis length specified as the total number of 'x_step's
	           	     x_start : 16,     //X-Axis offset in 'x_unit's
	           	     x_length : 48,    //number of 'x_step's that will be scrolled at a time
	           	     y_unit : doctors,	//sections of the view (titles of Y-Axis)
	           	     y_property : "doctor_id", //mapped data property
	           	     render : "bar"             //view mode
	           	});
        		
        		updateScheduler();
        	})
        	
        	scheduler.templates.event_text = function(start,end,ev) {
        		if (ev.patient) {
        			return ev.patient.fullname;
        		}
        		return ev.text;
        	};
        	
        	dhtmlXTooltip.config.className = 'dhtmlXTooltip tooltip'; 
        	dhtmlXTooltip.config.timeout_to_display = 50; 
        	dhtmlXTooltip.config.delta_x = 15; 
        	dhtmlXTooltip.config.delta_y = -20;
        	
        	var format = scheduler.date.date_to_str("%H:%i"); 
        	scheduler.templates.tooltip_text = function(start, end, ev) {
        		if (ev.patient) {
        			var content = "<b>Пациент:</b> "+ ev.patient.fullname + "<br/><b>Прием с </b> " + format(start) + "<b> по </b> " + format(end);
        			if (ev.first_time) {
        				content += '<br><span style="color: red;">Первичный прием!</span>'
        			}
        	    	return content;
        		}
        	};
        	
        	
        	scheduler.showLightbox = function(id) {
    			var ev = scheduler.getEvent(id);
    			scheduler.startLightbox(id, html("reception_form"));
    			$("#patient_name").focus().val(ev.patient ? ev.patient.fullname : '');
    			$("#description").val(ev.text);
    			$("#doctor_name").text(getDoctorName());
    			$("#reception_time").text(getTime(ev.start_date) + '-' + getTime(ev.end_date));
    			$('#first_time').prop('checked', ev.first_time);
    			var duration = $('#duration').empty();
    			for (var i = 0; i < 5; i++) {
    				var value = scheduler.config.event_duration * i;
    				duration.append($('<option>').val(value).text(value));
    			}
    		};
    		
    		$('#patient_name').autocomplete({
    			source : function(req, resp) {
    				jsRoutes.controllers.PatientsController.findPatientByName(req.term)
    					.ajax().done(function(data) {
    						resp($.map(data, function(item) {
    							return {id : item.key, label : item.fullname + ', ' + item.birthday, value : item.fullname }
    						}));
    					})
    			},
    			select: function( event, ui ) {
    				$.data(this, 'patient-id', ui.item.id);
    		      }
    		})
    		
			$('#patient_form').dialog({
				title: 'Новый пациент',
				width: '400px',
				resizable: true,
				autoOpen: false,
				modal: true,
				buttons: {
					'Сохранить': function() {
						$(this).submit();
					},
					'Закрыть' : function() {
						$(this).dialog('close');
					}
				},
				close: function() {
					
				}
			})
        })
        
		var html = function(id) { return document.getElementById(id); }; //just a helper
		var doctor_id;

		function save_form() {
			var ev = scheduler.getEvent(scheduler.getState().lightbox_id);
			ev.text = $("#description").val();
			if (!ev.patient) {
				ev.patient = {};
			}
			
			if (!ev.doctor) {
				ev.doctor = {};
			}
			var patientField = $("#patient_name");
			ev.patient.fullname = patientField.val();
			ev.patient.key = patientField.data('patient-id');
			ev.doctor.key = doctor_id;
			ev.first_time = $("#first_time").prop("checked");
			var newDuration = parseInt($("#duration").val());
			if (newDuration != 0) {
				ev.end_date.setMinutes(ev.end_date.getMinutes() + newDuration);
			}
			
			
			jsRoutes.controllers.ReceptionsController.saveReception().ajax({
				data : {
					id : ev.key,
					patient_id : ev.patient.key,
					doctor_id : ev.doctor.key,
					description: ev.text,
					start_date : ev.start_date.getTime(),
					end_date : ev.end_date.getTime(),
					first_time : ev.first_time
				}
			}).done(function(resp) {
				ev.key = resp;
				scheduler.updateEvent(ev.id);
			}).fail(function(resp) {
				alert(resp)
			}).always(function() {
				scheduler.endLightbox(true, html("reception_form"));
			})
		}
		
		function close_form() {
			scheduler.endLightbox(false, html("reception_form"));
		}

		function delete_event() {
			var ev = scheduler.getEvent(scheduler.getState().lightbox_id);
			if (confirm('Вы уверены что хотите удалить эту запись?')) {
				jsRoutes.controllers.ReceptionsController.deleteReception(ev.key).ajax()
					.done(function(resp) {
						scheduler.deleteEvent(ev.id);
					}).fail(function(resp) {
						alert('error')
					}).always(function() {
						scheduler.endLightbox(false, html("reception_form"));
					})
			} else {
				scheduler.endLightbox(false, html("reception_form"));
			}
		}
		
		function getDoctorName() {
			var mode = scheduler.getState().mode;
			var doctor = {};
			if (mode == 'unit') {
				doctor = scheduler._props[mode].options[doctor_id - 1];
			} else {
				doctor = scheduler.matrix[mode].y_unit[doctor_id - 1];	
			}
			return doctor.label;
		}
		
		function getTime(date) {
			return date.getHours() + ":" + date.getMinutes();
		}
		
		function updateScheduler() {
			var state = scheduler.getState();
			scheduler.clearAll();
			scheduler.init('scheduler_here', state.date === undefined ? new Date() : state.date, state.mode === undefined ? "unit" : state.mode);
        	scheduler.load('/receptions/get_all', 'json');
		}
		
		function addNewPatient() {
			$('#patient_form').dialog('open');
		}
    </script>
    <div id="patient_form" style="display: none;">
    	<label for="patient_surname">Фамилия:</label><input type="text" id="patient_surname" required><br>
    	<label for="patient_firstname">Имя:</label><input type="text" id="patient_firstname" required><br>
    	<label for="patient_patronymic">Отчество:</label><input type="text" id="patient_patronymic" required><br>
    	<label for="patient_birth_date">Дата рождения:</label><input type="date" id="patient_birth_date" required><br>
    	<label for="patient_phone_number">Номер телефона:</label><input type="tel" pattern="(\+?\d[- .]*){7,13}" id="patient_phone_number" required><br>
    </div>
	<div id="reception_form" style="display: none;">
		<div class="header"></div>
		<div class="content">
			<label for="reception_time" style="padding-right: 10px;">Время приема:</label><span id="reception_time"></span><br>
			<label for="doctor_name" style="padding-right: 10px;">Увеличить прием на (мин):</label><select id="duration" style="width: 50px;"></select><br>
			<label for="doctor_name" style="padding-right: 10px;">Доктор:</label><span id="doctor_name"></span><br>
			<label for="patient_name" style="padding-right: 10px;">Пациент:</label><input type="text" name="patient_name" value="" id="patient_name" 
				data-patinent-id="">
			<button onclick="addNewPatient()">Добавить</button>
			<br>
			<label for="patient_name" style="padding-right: 10px;">Первичный прием:</label><input type="checkbox" name="first_time" id="first_time"/><br>
			<label for="description" style="padding-right: 10px;">Описание:</label>
			<textarea name="description" id="description"></textarea><br>
		</div>
		
		<div class="footer">
			<input type="button" name="save" value="Save" id="save" style='width:100px;' onclick="save_form()">
			<input type="button" name="close" value="Close" id="close" style='width:100px;' onclick="close_form()">
			<input type="button" name="delete" value="Delete" id="delete" style='width:100px;' onclick="delete_event()">
		</div>
	</div>
	
    <div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%;'>
        <div class="dhx_cal_navline">
            <div class="dhx_cal_prev_button">&nbsp;</div>
            <div class="dhx_cal_next_button">&nbsp;</div>
            <div class="dhx_cal_today_button"></div>
            <div class="dhx_cal_date"></div>
<!--             <div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div> -->
<!--             <div class="dhx_cal_tab" name="week_tab" style="right:140px;"></div> -->
<!--             <div class="dhx_cal_tab" name="month_tab" style="right:76px;"></div> -->
	        <div class="dhx_cal_tab" name="unit_tab" style="right:280px;"></div>
			<div class="dhx_cal_tab" name="timeline_tab" style="right:280px;"></div>
			<button onclick="updateScheduler()">Refresh</button>
	    </div>
	    
        <div class="dhx_cal_header"></div>
        <div class="dhx_cal_data"></div>
    </div>
}